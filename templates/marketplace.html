{% extends "base.html" %}

{% block title %}Marketplace - KrushiMitra{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">
            <i class="fas fa-store text-green-600 mr-2"></i> Resource Marketplace
        </h1>
        
        <!-- Search and Filters -->
        <div class="space-y-4">
            <div class="w-full">
                <input type="text" id="searchInput" placeholder="Search resources..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-base">
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <select id="categoryFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-base bg-white">
                        <option value="all">All Categories</option>
                        <option value="farming_tools">üöú Farming Tools</option>
                        <option value="livestock">üêÑ Livestock</option>
                        <option value="electronics">‚ö° Electronics</option>
                        <option value="fertilizers">üå± Fertilizers</option>
                        <option value="pesticides">üêõ Pesticides</option>
                        <option value="seeds">üåæ Seeds</option>
                        <option value="irrigation">üíß Irrigation</option>
                        <option value="other">üì¶ Other</option>
                    </select>
                </div>
                
                <div>
                    <select id="sortFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-base bg-white">
                        <option value="newest">Newest First</option>
                        <option value="price_low">Price: Low to High</option>
                        <option value="price_high">Price: High to Low</option>
                        <option value="rating">Highest Rated</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Listing Type Filter -->
        <div class="flex flex-wrap gap-2 mt-4">
            <button onclick="filterByType('all')" class="flex-1 min-w-[80px] px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm sm:text-base" id="btn-all">
                All
            </button>
            <button onclick="filterByType('rent')" class="flex-1 min-w-[80px] px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm sm:text-base" id="btn-rent">
                For Rent
            </button>
            <button onclick="filterByType('borrow')" class="flex-1 min-w-[80px] px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm sm:text-base" id="btn-borrow">
                For Borrow
            </button>
            <button onclick="filterByType('sell')" class="flex-1 min-w-[80px] px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm sm:text-base" id="btn-sell">
                For Sale
            </button>
        </div>
    </div>

    <!-- Resources Grid -->
    <div id="resourcesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
        <!-- Resources will be populated here -->
    </div>
    
    <!-- Loading State -->
    <div id="loadingState" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-green-600"></i>
        <p class="text-gray-600 mt-4">Loading resources...</p>
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12">
        <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-600 text-lg">No resources found</p>
    </div>
</div>

<!-- Resource Detail Modal -->
<div id="resourceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-auto max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-start mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-900"></h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mobile menu functionality
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        mobileMenu.classList.toggle('hidden');
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuButton = document.querySelector('button[onclick="toggleMobileMenu()"]');
        
        if (!mobileMenu.contains(e.target) && !mobileMenuButton.contains(e.target) && !mobileMenu.classList.contains('hidden')) {
            mobileMenu.classList.add('hidden');
        }
    });
    let allResources = [];
    let currentFilter = 'all';
    // Logged-in flag from server
    const isLoggedIn = {{ 'true' if user else 'false' }};

    async function logout() {
        try {
            await auth.signOut();
            await fetch('/api/auth/logout', { method: 'POST' });
            // Redirect to marketplace after logout (users can continue browsing)
            window.location.href = '/marketplace';
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    async function fetchResources() {
        try {
            const category = document.getElementById('categoryFilter').value;
            const sort = document.getElementById('sortFilter').value;
            const search = document.getElementById('searchInput').value;
            
            let url = `/api/resources?sort=${sort}`;
            if (category !== 'all') url += `&category=${category}`;
            if (search) url += `&search=${search}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                allResources = data.data;
                displayResources(allResources);
            }
        } catch (error) {
            console.error('Resources fetch error:', error);
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }
    }

    function displayResources(resources) {
        const grid = document.getElementById('resourcesGrid');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        loadingState.classList.add('hidden');
        
        // Filter by listing type if needed
        let filteredResources = resources;
        if (currentFilter !== 'all') {
            filteredResources = resources.filter(r => r.listing_type === currentFilter);
        }
        
        if (filteredResources.length === 0) {
            grid.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        grid.innerHTML = filteredResources.map(resource => {
            const imgSrc = resource.image_url && resource.image_url !== '/static/images/placeholder.svg' 
                ? resource.image_url 
                : '/static/images/placeholder.svg';
            console.log('Resource:', resource.name, 'Image URL:', imgSrc);
            return `
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition cursor-pointer" onclick="showResourceDetail(${resource.id})">
                <img src="${imgSrc}" 
                     alt="${resource.name}" 
                     class="resource-image"
                     loading="lazy"
                     onerror="console.error('Image failed to load:', this.src); this.onerror=null; this.src='/static/images/placeholder.svg';">
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg">${resource.name}</h3>
                        <span class="text-xs bg-${getListingTypeColor(resource.listing_type)}-100 text-${getListingTypeColor(resource.listing_type)}-800 px-2 py-1 rounded">
                            ${resource.listing_type}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">${resource.description}</p>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-green-600 font-bold text-xl">‚Çπ${resource.price}</span>
                        <span class="text-yellow-500">
                            ${'‚òÖ'.repeat(Math.round(resource.rating))}${'‚òÜ'.repeat(5 - Math.round(resource.rating))}
                        </span>
                    </div>
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-map-marker-alt mr-1"></i> ${resource.owner.location}
                    </div>
                    <div class="mt-3 pt-3 border-t">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-user mr-2"></i>
                            <span>${resource.owner.name}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }

    function getListingTypeColor(type) {
        const colors = {
            'rent': 'blue',
            'borrow': 'green',
            'sell': 'purple'
        };
        return colors[type] || 'gray';
    }

    function filterByType(type) {
        currentFilter = type;
        
        // Update button styles
        ['all', 'rent', 'borrow', 'sell'].forEach(t => {
            const btn = document.getElementById(`btn-${t}`);
            if (t === type) {
                btn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition';
            } else {
                btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition';
            }
        });
        
        displayResources(allResources);
    }

    function showResourceDetail(resourceId) {
        const resource = allResources.find(r => r.id === resourceId);
        if (!resource) return;
        
        const modal = document.getElementById('resourceModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        
        modalTitle.textContent = resource.name;
        modalContent.innerHTML = `
            <!-- Image -->
            <div class="mb-6">
                <img src="${resource.image_url || '/static/images/placeholder.svg'}" alt="${resource.name}" class="w-full h-64 object-cover rounded-lg shadow-md" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
            </div>

            <!-- Details Grid -->
            <div class="grid grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                <div class="space-y-1">
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Category</p>
                    <p class="font-semibold text-gray-900 capitalize">${resource.category?.replace(/_/g,' ') || 'N/A'}</p>
                </div>
                <div class="space-y-1">
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Listing Type</p>
                    <p class="font-semibold text-gray-900 capitalize">${resource.listing_type || 'N/A'}</p>
                </div>
                <div class="space-y-1">
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Price</p>
                    <p class="font-bold text-green-600 text-xl">‚Çπ${resource.price}</p>
                </div>
                <div class="space-y-1">
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Condition</p>
                    <p class="font-semibold text-gray-900 capitalize">${resource.condition || 'N/A'}</p>
                </div>
                ${resource.age_years ? `
                <div class="space-y-1">
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Age</p>
                    <p class="font-semibold text-gray-900">${resource.age_years} years</p>
                </div>` : ''}
                ${resource.quality ? `
                <div class="space-y-1">
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Quality</p>
                    <p class="font-semibold text-gray-900">${resource.quality}/10</p>
                </div>` : ''}
            </div>

            <!-- Description -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-2">Description</h3>
                <p class="text-gray-800 leading-relaxed">${resource.description || ''}</p>
            </div>

            <!-- Owner Information -->
            <div class="border-t pt-6 mb-6">
                <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">
                    <i class="fas fa-user-circle mr-2 text-green-600"></i>Owner Information
                </h3>

                ${isLoggedIn ? `
                <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-lg p-4 space-y-3 border border-green-100">
                    <div class="flex items-center"><i class="fas fa-user mr-3 w-5 text-green-600"></i><span class="font-semibold text-gray-900">${resource.owner?.name || 'Owner'}</span></div>
                    ${resource.owner?.email ? `<div class=\"flex items-center\"><i class=\"fas fa-envelope mr-3 w-5 text-green-600\"></i><a class=\"text-blue-600 hover:underline break-all\" href=\"mailto:${resource.owner.email}\">${resource.owner.email}</a></div>` : ''}
                    ${resource.owner?.phone ? `<div class=\"flex items-center\"><i class=\"fas fa-phone mr-3 w-5 text-green-600\"></i><a class=\"text-blue-600 hover:underline font-medium\" href=\"tel:${resource.owner.phone}\">${resource.owner.phone}</a></div>` : ''}
                    ${resource.owner?.location ? `<div class=\"flex items-center\"><i class=\"fas fa-map-marker-alt mr-3 w-5 text-green-600\"></i><span class=\"text-gray-700\">${resource.owner.location}</span></div>` : ''}
                </div>
                ` : `
                <div class="relative">
                    <div class="bg-gray-100 rounded-lg p-4 space-y-3 blur-sm select-none pointer-events-none">
                        <div class="flex items-center"><i class="fas fa-user mr-3 w-5 text-gray-400"></i><span class="font-semibold text-gray-600">John Doe</span></div>
                        <div class="flex items-center"><i class="fas fa-envelope mr-3 w-5 text-gray-400"></i><span class="text-gray-600">owner@example.com</span></div>
                        <div class="flex items-center"><i class="fas fa-phone mr-3 w-5 text-gray-400"></i><span class="text-gray-600">+91 9876543210</span></div>
                        <div class="flex items-center"><i class="fas fa-map-marker-alt mr-3 w-5 text-gray-400"></i><span class="text-gray-600">Location</span></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-lg">
                        <div class="text-center p-4">
                            <i class="fas fa-lock text-blue-600 text-3xl mb-2"></i>
                            <p class="font-semibold text-gray-900 mb-1">Login to View Contact</p>
                            <p class="text-sm text-gray-600">Sign in to see owner details</p>
                        </div>
                    </div>
                </div>
                `}
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                ${isLoggedIn && resource.owner?.phone ? `
                <a href="tel:${resource.owner.phone}" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition text-center flex items-center justify-center font-medium shadow-md"><i class="fas fa-phone mr-2"></i> Call</a>
                <a href="https://wa.me/${(resource.owner.phone||'').replace(/\D/g,'')}" target="_blank" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition text-center flex items-center justify-center font-medium shadow-md"><i class="fab fa-whatsapp mr-2 text-lg"></i> WhatsApp</a>
                <button onclick="closeModal()" class="bg-gray-200 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-300 transition font-medium shadow-md"><i class="fas fa-times mr-2"></i> Close</button>
                ` : `
                <a href="/login" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition text-center flex items-center justify-center font-medium shadow-md"><i class="fas fa-sign-in-alt mr-2"></i> Login</a>
                <a href="/signup" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition text-center flex items-center justify-center font-medium shadow-md"><i class="fas fa-user-plus mr-2"></i> Sign Up</a>
                <button onclick="closeModal()" class="bg-gray-200 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-300 transition font-medium shadow-md"><i class="fas fa-times mr-2"></i> Close</button>
                `}
            </div>
        `;
        
        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('resourceModal').classList.add('hidden');
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', fetchResources);
    document.getElementById('categoryFilter').addEventListener('change', fetchResources);
    document.getElementById('sortFilter').addEventListener('change', fetchResources);

    // Close modal on outside click
    document.getElementById('resourceModal').addEventListener('click', (e) => {
        if (e.target.id === 'resourceModal') {
            closeModal();
        }
    });

    // Initialize
    window.addEventListener('load', fetchResources);
</script>
{% endblock %}
