{% extends "base.html" %}

{% block title %}My Resources - KrushiMitra{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="bg-green-600 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <i class="fas fa-tractor text-white text-2xl mr-3"></i>
                <span class="text-white text-xl font-bold">KrushiMitra</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/dashboard" class="text-white hover:text-green-200">
                    <i class="fas fa-home mr-1"></i> Dashboard
                </a>
                <a href="/marketplace" class="text-white hover:text-green-200">
                    <i class="fas fa-store mr-1"></i> Marketplace
                </a>
                <a href="/add-resource" class="text-white hover:text-green-200">
                    <i class="fas fa-plus-circle mr-1"></i> Add Resource
                </a>
                <a href="/my-resources" class="text-white hover:text-green-200">
                    <i class="fas fa-box mr-1"></i> My Resources
                </a>
                <a href="/profile" class="text-white hover:text-green-200">
                    <i class="fas fa-user mr-1"></i> Profile
                </a>
                <div class="language-selector">
                    <i class="fas fa-globe"></i>
                    <div id="google_translate_element"></div>
                </div>
                <button onclick="logout()" class="text-white hover:text-green-200">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fas fa-box text-green-600 mr-2"></i> My Resources
            </h1>
            <a href="/add-resource" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                <i class="fas fa-plus-circle mr-2"></i> Add New Resource
            </a>
        </div>
    </div>

    <!-- Resources Grid -->
    <div id="resourcesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Resources will be populated here -->
    </div>
    
    <!-- Loading State -->
    <div id="loadingState" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-green-600"></i>
        <p class="text-gray-600 mt-4">Loading your resources...</p>
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12 bg-white rounded-lg shadow-md">
        <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-600 text-lg mb-4">You haven't added any resources yet</p>
        <a href="/add-resource" class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
            <i class="fas fa-plus-circle mr-2"></i> Add Your First Resource
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function logout() {
        try {
            await auth.signOut();
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    async function fetchMyResources() {
        try {
            const response = await fetch('/api/resources/my');
            const data = await response.json();
            
            document.getElementById('loadingState').classList.add('hidden');
            
            if (data.success) {
                if (data.data.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    displayResources(data.data);
                }
            }
        } catch (error) {
            console.error('Resources fetch error:', error);
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }
    }

    function displayResources(resources) {
        const grid = document.getElementById('resourcesGrid');
        
        grid.innerHTML = resources.map(resource => `
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <img src="${resource.image_url || '/static/images/placeholder.jpg'}" alt="${resource.name}" class="w-full h-48 object-cover">
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg">${resource.name}</h3>
                        <span class="text-xs ${resource.is_available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-1 rounded">
                            ${resource.is_available ? 'Available' : 'Unavailable'}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">${resource.description.substring(0, 80)}${resource.description.length > 80 ? '...' : ''}</p>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-green-600 font-bold text-xl">â‚¹${resource.price}</span>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded capitalize">${resource.listing_type}</span>
                    </div>
                    <div class="text-sm text-gray-500 mb-3">
                        <i class="fas fa-calendar mr-1"></i> Added ${new Date(resource.created_at).toLocaleDateString()}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleAvailability(${resource.id}, ${!resource.is_available})" 
                                class="flex-1 ${resource.is_available ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white px-3 py-2 rounded text-sm transition">
                            <i class="fas fa-${resource.is_available ? 'pause' : 'play'} mr-1"></i>
                            ${resource.is_available ? 'Mark Unavailable' : 'Mark Available'}
                        </button>
                        <button onclick="deleteResource(${resource.id})" 
                                class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function toggleAvailability(resourceId, isAvailable) {
        try {
            const response = await fetch(`/api/resources/${resourceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ is_available: isAvailable })
            });
            
            const data = await response.json();
            
            if (data.success) {
                fetchMyResources(); // Refresh the list
            } else {
                alert('Failed to update resource');
            }
        } catch (error) {
            console.error('Update error:', error);
            alert('An error occurred');
        }
    }

    async function deleteResource(resourceId) {
        if (!confirm('Are you sure you want to delete this resource?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/resources/${resourceId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                fetchMyResources(); // Refresh the list
            } else {
                alert('Failed to delete resource');
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('An error occurred');
        }
    }

    // Initialize
    window.addEventListener('load', fetchMyResources);
</script>
{% endblock %}
